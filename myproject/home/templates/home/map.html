<!DOCTYPE html>
<html>
<head>
    <title>Báº£n Ä‘á»“ ÄH TÃ i nguyÃªn vÃ  MÃ´i trÆ°á»ng TP.HCM</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100%; height: 100vh; } /* Báº£n Ä‘á»“ full mÃ n hÃ¬nh */
        
        /* Style cho Legend (ChÃº thÃ­ch) */
        .leaflet-popup-content-wrapper { border-radius: 5px; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- A. Khá»Ÿi táº¡o báº£n Ä‘á»“ ---
        // Tá»a Ä‘á»™ HCMUNRE (LÃª VÄƒn Sá»¹): [10.7984, 106.6655]
        var map = L.map('map').setView([10.7984, 106.6655], 18);

        // --- B. ThÃªm lá»›p ná»n (Base Map) ---
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // --- C. Nháº­n dá»¯ liá»‡u tá»« Django View ---
        // Dá»¯ liá»‡u nÃ y Ä‘Æ°á»£c truyá»n tá»« views.py
        var buildingsData = {{ buildings_json|safe }};
        var treesData = {{ trees_json|safe }};
        var incidentsData = {{ incidents_json|safe }};

        // --- D. Äá»‹nh nghÄ©a Style cho tá»«ng lá»›p ---

        // 1. Style TÃ²a nhÃ  (MÃ u xanh dÆ°Æ¡ng Ä‘áº­m, viá»n rÃµ)
        var buildingStyle = {
            "color": "#2980b9",
            "weight": 3,
            "opacity": 1,
            "fillColor": "#3498db",
            "fillOpacity": 0.5
        };

        // 2. Style CÃ¢y (HÃ¬nh trÃ²n mÃ u xanh lÃ¡)
        function treePoint(feature, latlng) {
            var color = "#27ae60"; // Xanh lÃ¡ máº·c Ä‘á»‹nh
            if (feature.properties.health_status == 'diseased') color = "#f39c12"; // Cam
            if (feature.properties.health_status == 'dangerous') color = "#c0392b"; // Äá»
            
            return L.circleMarker(latlng, {
                radius: 5,
                fillColor: color,
                color: "#fff",
                weight: 1,
                opacity: 1,
                fillOpacity: 1
            });
        }

        // 3. Style Sá»± cá»‘ (HÃ¬nh trÃ²n nháº¥p nhÃ¡y Ä‘á»)
        function incidentPoint(feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 10,
                fillColor: "#e74c3c", 
                color: "#c0392b",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });
        }

        // --- E. ThÃªm cÃ¡c lá»›p vÃ o báº£n Ä‘á»“ ---

        // Lá»›p TÃ²a nhÃ 
        var buildingsLayer = L.geoJSON(buildingsData, {
            style: buildingStyle,
            onEachFeature: function (feature, layer) {
                layer.bindPopup("<b>ğŸ¢ " + feature.properties.name + "</b><br>" + feature.properties.description);
            }
        }).addTo(map);

        // Lá»›p CÃ¢y xanh
        var treesLayer = L.geoJSON(treesData, {
            pointToLayer: treePoint,
            onEachFeature: function (feature, layer) {
                var status = feature.properties.health_status;
                var icon = "ğŸŒ³";
                if (status == 'dangerous') icon = "âš ï¸";
                layer.bindPopup("<b>" + icon + " CÃ¢y: " + feature.properties.species + "</b><br>MÃ£: " + feature.properties.code + "<br>TÃ¬nh tráº¡ng: " + status);
            }
        }).addTo(map);

        // Lá»›p Sá»± cá»‘
        var incidentsLayer = L.geoJSON(incidentsData, {
            pointToLayer: incidentPoint,
            onEachFeature: function (feature, layer) {
                var priority = feature.properties.priority;
                var color = priority == 'high' ? 'red' : 'black';
                layer.bindPopup("<b>ğŸ”¥ Sá»° Cá»: " + feature.properties.title + "</b><br>Má»©c Ä‘á»™: <span style='color:"+color+"'><b>" + priority.toUpperCase() + "</b></span><br>Tráº¡ng thÃ¡i: " + feature.properties.status);
            }
        }).addTo(map);

        // --- F. Bá»™ Ä‘iá»u khiá»ƒn Layer ---
        var overlayMaps = {
            "TÃ²a nhÃ ": buildingsLayer,
            "CÃ¢y xanh": treesLayer,
            "Sá»± cá»‘": incidentsLayer
        };
        L.control.layers(null, overlayMaps).addTo(map);

    </script>
</body>
</html>