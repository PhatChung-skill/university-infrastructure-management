<!DOCTYPE html>
<html lang="vi">
<head>
    <title>B·∫£n ƒë·ªì ƒêH T√†i nguy√™n v√† M√¥i tr∆∞·ªùng TP.HCM</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { --topbar-h: 56px; }
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; }
        #map { width: 100%; height: 100vh; } /* B·∫£n ƒë·ªì full m√†n h√¨nh */
        
        /* Style cho Legend (Ch√∫ th√≠ch) */
        .leaflet-popup-content-wrapper { border-radius: 5px; }

        /* Back bar */
        .map-topbar{
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            height: var(--topbar-h);
            z-index: 1100;
            background: linear-gradient(135deg, #2e7d32, #43a047);
            color: #e8f5e9;
            box-shadow: 0 6px 18px rgba(0,0,0,.15);
            display: flex;
            align-items: center;
        }
        .map-topbar .inner{
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 0 14px;
        }
        .map-topbar a.back{
            color: #e8f5e9;
            text-decoration: none;
            font-weight: 600;
            padding: 8px 10px;
            border-radius: 10px;
            background: rgba(255,255,255,.12);
        }
        .map-topbar a.back:hover{ background: rgba(255,255,255,.18); }
        .map-topbar .title{
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Kh√¥ng che m·∫•t control c·ªßa leaflet ·ªü g√≥c tr√°i tr√™n */
        .leaflet-top.leaflet-left{ top: calc(var(--topbar-h) + 10px); }
    </style>
</head>
<body>

    <div class="map-topbar">
        <div class="inner">
            <div>
                {% if back_url %}
                    <a class="back" href="{{ back_url }}">{{ back_label }}</a>
                {% else %}
                    <a class="back" href="{% url 'login' %}">‚Üê Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
                {% endif %}
            </div>
            <div class="title">B·∫£n ƒë·ªì khu√¥n vi√™n</div>
            <div style="width: 1px;"></div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- A. Kh·ªüi t·∫°o b·∫£n ƒë·ªì ---
        // T·ªça ƒë·ªô HCMUNRE (L√™ VƒÉn S·ªπ): [10.7984, 106.6655]
        var map = L.map('map').setView([10.7984, 106.6655], 18);

        // --- B. Th√™m l·ªõp n·ªÅn (Base Map) ---
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // --- C. Nh·∫≠n d·ªØ li·ªáu t·ª´ Django View ---
        // D·ªØ li·ªáu n√†y ƒë∆∞·ª£c truy·ªÅn t·ª´ views.py
        var buildingsData = {{ buildings_json|safe }};
        var treesData = {{ trees_json|safe }};
        var incidentsData = {{ incidents_json|safe }};

        // --- D0. Mapping hi·ªÉn th·ªã ti·∫øng Vi·ªát ---
        var VI_TREE_STATUS = {
            "good": "T·ªët",
            "diseased": "B·ªánh",
            "dangerous": "Nguy hi·ªÉm"
        };

        var VI_INCIDENT_PRIORITY = {
            "low": "Th·∫•p",
            "medium": "Trung b√¨nh",
            "high": "Cao"
        };

        var VI_INCIDENT_STATUS = {
            "open": "M·ªü",
            "processing": "ƒêang x·ª≠ l√Ω",
            "closed": "ƒê√£ ƒë√≥ng"
        };

        // --- D. ƒê·ªãnh nghƒ©a Style cho t·ª´ng l·ªõp ---

        // 1. Style T√≤a nh√† (M√†u xanh d∆∞∆°ng ƒë·∫≠m, vi·ªÅn r√µ)
        var buildingStyle = {
            "color": "#2980b9",
            "weight": 3,
            "opacity": 1,
            "fillColor": "#3498db",
            "fillOpacity": 0.5
        };

        // 2. Style C√¢y (H√¨nh tr√≤n m√†u xanh l√°)
        function treePoint(feature, latlng) {
            var color = "#27ae60"; // Xanh l√° m·∫∑c ƒë·ªãnh
            if (feature.properties.health_status == 'diseased') color = "#f39c12"; // Cam
            if (feature.properties.health_status == 'dangerous') color = "#c0392b"; // ƒê·ªè
            
            return L.circleMarker(latlng, {
                radius: 5,
                fillColor: color,
                color: "#fff",
                weight: 1,
                opacity: 1,
                fillOpacity: 1
            });
        }

        // 3. Style S·ª± c·ªë (H√¨nh tr√≤n nh·∫•p nh√°y ƒë·ªè)
        function incidentPoint(feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 10,
                fillColor: "#e74c3c", 
                color: "#c0392b",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });
        }

        // --- E. Th√™m c√°c l·ªõp v√†o b·∫£n ƒë·ªì ---

        // L·ªõp T√≤a nh√†
        var buildingsLayer = L.geoJSON(buildingsData, {
            style: buildingStyle,
            onEachFeature: function (feature, layer) {
                layer.bindPopup("<b>üè¢ " + feature.properties.name + "</b><br>" + feature.properties.description);
            }
        }).addTo(map);

        // L·ªõp C√¢y xanh
        var treesLayer = L.geoJSON(treesData, {
            pointToLayer: treePoint,
            onEachFeature: function (feature, layer) {
                var status = feature.properties.health_status;
                var icon = "üå≥";
                if (status == 'dangerous') icon = "‚ö†Ô∏è";
                var viStatus = VI_TREE_STATUS[status] || status;
                layer.bindPopup(
                    "<b>" + icon + " C√¢y: " + feature.properties.species + "</b>"
                    + "<br>M√£: " + feature.properties.code
                    + "<br>T√¨nh tr·∫°ng: " + viStatus
                );
            }
        }).addTo(map);

        // L·ªõp S·ª± c·ªë
        var incidentsLayer = L.geoJSON(incidentsData, {
            pointToLayer: incidentPoint,
            onEachFeature: function (feature, layer) {
                var priority = feature.properties.priority;
                var status = feature.properties.status;
                var viPriority = VI_INCIDENT_PRIORITY[priority] || priority;
                var viStatus = VI_INCIDENT_STATUS[status] || status;
                var color = priority == 'high' ? 'red' : (priority == 'medium' ? '#f39c12' : '#2e7d32');
                layer.bindPopup(
                    "<b>üî• S·ª∞ C·ªê: " + feature.properties.title + "</b>"
                    + "<br>M·ª©c ƒë·ªô: <span style='color:" + color + "'><b>" + viPriority + "</b></span>"
                    + "<br>Tr·∫°ng th√°i: " + viStatus
                );
            }
        }).addTo(map);

        // --- F. B·ªô ƒëi·ªÅu khi·ªÉn Layer ---
        var overlayMaps = {
            "T√≤a nh√†": buildingsLayer,
            "C√¢y xanh": treesLayer,
            "S·ª± c·ªë": incidentsLayer
        };
        L.control.layers(null, overlayMaps).addTo(map);

    </script>
</body>
</html>