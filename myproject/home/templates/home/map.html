<!DOCTYPE html>
<html lang="vi">
<head>
    <title>B·∫£n ƒë·ªì ƒêH T√†i nguy√™n v√† M√¥i tr∆∞·ªùng TP.HCM</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { --topbar-h: 56px; }
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; }
        #map { width: 100%; height: 100vh; } /* B·∫£n ƒë·ªì full m√†n h√¨nh */
        
        /* Style cho popup Leaflet */
        .leaflet-popup-content-wrapper { border-radius: 5px; }

        /* Back bar */
        .map-topbar{
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            height: var(--topbar-h);
            z-index: 1100;
            background: linear-gradient(135deg, #2e7d32, #43a047);
            color: #e8f5e9;
            box-shadow: 0 6px 18px rgba(0,0,0,.15);
            display: flex;
            align-items: center;
        }
        .map-topbar .inner{
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 0 14px;
        }
        .map-topbar a.back{
            color: #e8f5e9;
            text-decoration: none;
            font-weight: 600;
            padding: 8px 10px;
            border-radius: 10px;
            background: rgba(255,255,255,.12);
        }
        .map-topbar a.back:hover{ background: rgba(255,255,255,.18); }
        .map-topbar .title{
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Kh√¥ng che m·∫•t control c·ªßa leaflet ·ªü g√≥c tr√°i tr√™n */
        .leaflet-top.leaflet-left{ top: calc(var(--topbar-h) + 10px); }

        /* Legend (ch√∫ th√≠ch) */
        .map-legend {
            position: fixed;
            right: 12px;
            bottom: 12px;
            z-index: 1100;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 13px;
            max-width: 260px;
        }
        .map-legend h4 {
            margin: 0 0 6px;
            font-size: 13px;
            font-weight: 700;
        }
        .map-legend .legend-group {
            margin-bottom: 4px;
        }
        .map-legend .legend-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        .map-legend .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 1px 0;
        }
        .map-legend .color-box {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 1px solid #ccc;
        }
        .map-legend .legend-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin: 0;
            padding: 4px 0 6px;
            border: none;
            background: none;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            color: inherit;
        }
        .map-legend .legend-toggle:hover {
            opacity: 0.85;
        }
        .map-legend .legend-toggle .icon {
            font-size: 12px;
            transition: transform 0.2s;
        }
        .map-legend.collapsed .legend-toggle .icon {
            transform: rotate(-90deg);
        }
        .map-legend .legend-body {
            max-height: 420px;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
        }
        .map-legend.collapsed .legend-body {
            max-height: 0 !important;
            padding-top: 0;
            padding-bottom: 0;
            margin: 0;
        }

        /* Toolbar b√™n tr√°i cho c√°c tool truy v·∫•n (n·∫±m d∆∞·ªõi n√∫t zoom +/-) */
        .map-toolbar {
            position: fixed;
            left: 10px;
            top: calc(var(--topbar-h) + 10px + 75px);
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .map-toolbar button {
            border: none;
            padding: 8px 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            font-size: 13px;
            text-align: left;
            min-width: 160px;
        }
        .map-toolbar button:hover {
            background: #e8f5e9;
        }

        /* Panel k·∫øt qu·∫£ truy v·∫•n n√¢ng cao b√™n ph·∫£i */
        .query-panel {
            position: fixed;
            right: 12px;
            top: calc(var(--topbar-h) + 16px);
            z-index: 1100;
            background: rgba(255, 255, 255, 0.97);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.18);
            border-radius: 10px;
            padding: 10px 12px;
            width: 280px;
            max-height: calc(100vh - var(--topbar-h) - 40px);
            overflow: auto;
            font-size: 13px;
        }
        .query-panel h4 {
            margin: 0 0 6px;
            font-size: 13px;
        }
        .query-panel .query-buttons {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 6px;
        }
        .query-panel .query-buttons button {
            border: none;
            padding: 6px 8px;
            border-radius: 6px;
            background: #f5f5f5;
            cursor: pointer;
            text-align: left;
        }
        .query-panel .query-buttons button:hover {
            background: #e3f2fd;
        }
        .query-panel .query-results {
            border-top: 1px solid #eee;
            padding-top: 4px;
            margin-top: 4px;
        }
        .query-panel .result-item {
            padding: 3px 0;
            border-bottom: 1px dashed #eee;
        }
        .query-panel .incident-search {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid #eee;
        }
        .query-panel .incident-search input {
            width: 100%;
            box-sizing: border-box;
            padding: 4px 6px;
            margin-bottom: 4px;
            font-size: 13px;
        }
        .query-panel .incident-search button {
            width: 100%;
        }
    </style>
</head>
<body>

    <div class="map-topbar">
        <div class="inner">
            <div>
                {% if back_url %}
                    <a class="back" href="{{ back_url }}">{{ back_label }}</a>
                {% else %}
                    <a class="back" href="{% url 'login' %}">‚Üê Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
                {% endif %}
            </div>
            <div class="title">B·∫£n ƒë·ªì khu√¥n vi√™n</div>
            <div style="width: 1px;"></div>
        </div>
    </div>

    <!-- Toolbar tool truy v·∫•n -->
    <div class="map-toolbar">
        <button id="btn-radius-search">üîç Truy v·∫•n b√°n k√≠nh</button>
        <button id="btn-show-all">‚¨ÖÔ∏è Quay l·∫°i b·∫£n ƒë·ªì g·ªëc</button>
    </div>

    <!-- Panel truy v·∫•n n√¢ng cao -->
    <div class="query-panel">
        <h4>Truy v·∫•n n√¢ng cao</h4>
        <div class="query-buttons">
            <button id="btn-dangerous-trees">üå≥ C√¢y nguy hi·ªÉm</button>
            <button id="btn-devices-check">‚öôÔ∏è Thi·∫øt b·ªã c·∫ßn ki·ªÉm tra</button>
        </div>
        <div id="query-results" class="query-results"></div>
        <div class="incident-search">
            <div style="font-weight:600; margin-bottom:2px;">T√¨m ki·∫øm s·ª± c·ªë</div>
            <input id="incident-search-input" type="text" placeholder="VD: cao, trung b√¨nh, th·∫•p, m·ªü, loa, me t√¢y, pc ƒë√†i loan..." />
            <button id="btn-search-incidents">üö® T√¨m s·ª± c·ªë tr√™n b·∫£n ƒë·ªì</button>
        </div>
    </div>

    <!-- Legend ch√∫ th√≠ch (c√≥ th·ªÉ ƒë√≥ng/m·ªü) -->
    <div class="map-legend" id="map-legend">
        <button type="button" class="legend-toggle" id="legend-toggle" aria-expanded="true">
            <span>Ch√∫ th√≠ch b·∫£n ƒë·ªì</span>
            <span class="icon">‚ñº</span>
        </button>
        <div class="legend-body" id="legend-body">
        <div class="legend-group">
            <div class="legend-title">C√¢y xanh</div>
            <div class="legend-item">
                <span class="color-box" style="background:#27ae60;"></span>
                <span>C√¢y kh·ªèe</span>
            </div>
            <div class="legend-item">
                <span class="color-box" style="background:#f39c12;"></span>
                <span>C√¢y b·ªánh</span>
            </div>
            <div class="legend-item">
                <span class="color-box" style="background:#c0392b;"></span>
                <span>C√¢y nguy hi·ªÉm</span>
            </div>
        </div>
        <div class="legend-group">
            <div class="legend-title">Thi·∫øt b·ªã</div>
            <div class="legend-item">
                <span class="color-box" style="background:#1565c0;"></span>
                <span>Tr·∫°ng th√°i t·ªët</span>
            </div>
            <div class="legend-item">
                <span class="color-box" style="background:#f9a825;"></span>
                <span>ƒêang s·ª≠a</span>
            </div>
            <div class="legend-item">
                <span class="color-box" style="background:#c62828;"></span>
                <span>H·ªèng</span>
            </div>
        </div>
        <div class="legend-group">
            <div class="legend-title">Khu v·ª±c / Ph√≤ng</div>
            <div class="legend-item">
                <span class="color-box" style="background:#3498db;"></span>
                <span>T√≤a nh√†</span>
            </div>
            <div class="legend-item">
                <span class="color-box" style="background:#9b59b6;"></span>
                <span>Ph√≤ng h·ªçc / Ph√≤ng</span>
            </div>
        </div>
        <div class="legend-group">
            <div class="legend-title">S·ª± c·ªë</div>
            <div class="legend-item">
                <span class="color-box" style="background:#e74c3c;"></span>
                <span>S·ª± c·ªë tr√™n b·∫£n ƒë·ªì</span>
            </div>
        </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- A. Kh·ªüi t·∫°o b·∫£n ƒë·ªì ---
        // T·ªça ƒë·ªô HCMUNRE (L√™ VƒÉn S·ªπ): [10.7984, 106.6655]
        var map = L.map('map').setView([10.7984, 106.6655], 18);

        // --- B. Th√™m l·ªõp n·ªÅn (Base Map) ---
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // --- B0. Cho ph√©p m·ªü map theo t·ªça ƒë·ªô t·ª´ URL (t·ª´ trang admin) ---
        (function() {
            var params = new URLSearchParams(window.location.search);
            var lat = parseFloat(params.get('lat'));
            var lng = parseFloat(params.get('lng'));
            var zoom = parseInt(params.get('zoom') || '20', 10);
            if (!isNaN(lat) && !isNaN(lng)) {
                map.setView([lat, lng], isNaN(zoom) ? 20 : zoom);
            }
        })();

        // --- C. Nh·∫≠n d·ªØ li·ªáu t·ª´ Django View ---
        // D·ªØ li·ªáu n√†y ƒë∆∞·ª£c truy·ªÅn t·ª´ views.py
        var buildingsData = {{ buildings_json|safe }};
        var treesData = {{ trees_json|safe }};
        var incidentsData = {{ incidents_json|safe }};
        var roomsData = {{ rooms_json|safe }};
        var equipmentData = {{ equipment_json|safe }};

        // URL API cho c√°c tool truy v·∫•n
        var radiusSearchUrl = "{% url 'radius_search' %}";
        var dangerousTreesUrl = "{% url 'dangerous_trees' %}";
        var devicesToCheckUrl = "{% url 'devices_to_check' %}";

        // --- D0. Mapping hi·ªÉn th·ªã ti·∫øng Vi·ªát ---
        var VI_TREE_STATUS = {
            "good": "T·ªët",
            "diseased": "B·ªánh",
            "dangerous": "Nguy hi·ªÉm"
        };

        var VI_INCIDENT_PRIORITY = {
            "low": "Th·∫•p",
            "medium": "Trung b√¨nh",
            "high": "Cao"
        };

        var VI_INCIDENT_STATUS = {
            "open": "M·ªü",
            "processing": "ƒêang x·ª≠ l√Ω",
            "closed": "ƒê√£ ƒë√≥ng"
        };

        var VI_EQUIPMENT_STATUS = {
            "good": "T·ªët",
            "maintenance": "ƒêang s·ª≠a",
            "broken": "H·ªèng"
        };

        // --- D. ƒê·ªãnh nghƒ©a Style cho t·ª´ng l·ªõp ---

        // 1. Style T√≤a nh√† (M√†u xanh d∆∞∆°ng ƒë·∫≠m, vi·ªÅn r√µ)
        var buildingStyle = {
            "color": "#2980b9",
            "weight": 3,
            "opacity": 1,
            "fillColor": "#3498db",
            "fillOpacity": 0.5
        };

        // 2. Style C√¢y (H√¨nh tr√≤n m√†u xanh l√°)
        function treePoint(feature, latlng) {
            var color = "#27ae60"; // Xanh l√° m·∫∑c ƒë·ªãnh
            if (feature.properties.health_status == 'diseased') color = "#f39c12"; // Cam
            if (feature.properties.health_status == 'dangerous') color = "#c0392b"; // ƒê·ªè
            
            return L.circleMarker(latlng, {
                radius: 5,
                fillColor: color,
                color: "#fff",
                weight: 1,
                opacity: 1,
                fillOpacity: 1
            });
        }

        // 3. Style S·ª± c·ªë (H√¨nh tr√≤n ƒë·ªè)
        function incidentPoint(feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 10,
                fillColor: "#e74c3c",
                color: "#c0392b",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });
        }

        // 4. Style Ph√≤ng (h√¨nh vu√¥ng t√≠m)
        function roomPoint(feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 6,
                fillColor: "#9b59b6",
                color: "#fff",
                weight: 1,
                fillOpacity: 1
            });
        }

        // 5. Style Thi·∫øt b·ªã (m√†u theo tr·∫°ng th√°i: t·ªët = xanh bi·ªÉn ƒë·∫≠m, ƒëang s·ª≠a = v√†ng, h·ªèng = ƒë·ªè ƒë·∫≠m)
        var EQUIPMENT_COLORS = {
            "good": { fill: "#1565c0", stroke: "#0d47a1" },
            "maintenance": { fill: "#f9a825", stroke: "#f57f17" },
            "broken": { fill: "#c62828", stroke: "#b71c1c" }
        };
        function equipmentPoint(feature, latlng) {
            var status = (feature.properties && feature.properties.status) || "good";
            var colors = EQUIPMENT_COLORS[status] || EQUIPMENT_COLORS["good"];
            return L.circleMarker(latlng, {
                radius: 6,
                fillColor: colors.fill,
                color: colors.stroke,
                weight: 1,
                fillOpacity: 1
            });
        }

        // --- E. Th√™m c√°c l·ªõp v√†o b·∫£n ƒë·ªì ---

        // L·ªõp T√≤a nh√†
        var buildingsLayer = L.geoJSON(buildingsData, {
            style: buildingStyle,
            onEachFeature: function (feature, layer) {
                layer.bindPopup("<b>üè¢ " + feature.properties.name + "</b><br>" + feature.properties.description);
            }
        }).addTo(map);

        // L·ªõp C√¢y xanh
        var treesLayer = L.geoJSON(treesData, {
            pointToLayer: treePoint,
            onEachFeature: function (feature, layer) {
                var status = feature.properties.health_status;
                var icon = "üå≥";
                if (status == 'dangerous') icon = "‚ö†Ô∏è";
                var viStatus = VI_TREE_STATUS[status] || status;
                layer.bindPopup(
                    "<b>" + icon + " C√¢y: " + feature.properties.species + "</b>"
                    + "<br>M√£: " + feature.properties.code
                    + "<br>T√¨nh tr·∫°ng: " + viStatus
                );
            }
        }).addTo(map);

        // L·ªõp S·ª± c·ªë
        var incidentsLayer = L.geoJSON(incidentsData, {
            pointToLayer: incidentPoint,
            onEachFeature: function (feature, layer) {
                var priority = feature.properties.priority;
                var status = feature.properties.status;
                var viPriority = VI_INCIDENT_PRIORITY[priority] || priority;
                var viStatus = VI_INCIDENT_STATUS[status] || status;
                var color = priority == 'high' ? 'red' : (priority == 'medium' ? '#f39c12' : '#2e7d32');
                layer.bindPopup(
                    "<b>üî• S·ª∞ C·ªê: " + feature.properties.title + "</b>"
                    + "<br>M·ª©c ƒë·ªô: <span style='color:" + color + "'><b>" + viPriority + "</b></span>"
                    + "<br>Tr·∫°ng th√°i: " + viStatus
                );
            }
        }).addTo(map);

        // L·ªõp Ph√≤ng
        var roomsLayer = L.geoJSON(roomsData, {
            pointToLayer: roomPoint,
            onEachFeature: function (feature, layer) {
                layer.bindPopup(
                    "<b>üö™ Ph√≤ng: " + (feature.properties.name || "") + "</b>"
                    + "<br>Lo·∫°i: " + (feature.properties.room_type || "")
                );
            }
        }).addTo(map);

        // L·ªõp Thi·∫øt b·ªã
        var equipmentLayer = L.geoJSON(equipmentData, {
            pointToLayer: equipmentPoint,
            onEachFeature: function (feature, layer) {
                var st = feature.properties && feature.properties.status;
                var viStatus = VI_EQUIPMENT_STATUS[st] || st || "";
                layer.bindPopup(
                    "<b>‚öôÔ∏è Thi·∫øt b·ªã: " + (feature.properties.code || "") + "</b>"
                    + "<br>T√™n: " + (feature.properties.name || "")
                    + "<br>Tr·∫°ng th√°i: " + viStatus
                );
            }
        }).addTo(map);

        // L·ªõp ri√™ng ƒë·ªÉ hi·ªÉn th·ªã k·∫øt qu·∫£ truy v·∫•n
        var radiusResultLayer = L.layerGroup().addTo(map);
        var advancedResultLayer = L.layerGroup().addTo(map);

        // --- F. B·ªô ƒëi·ªÅu khi·ªÉn Layer ---
        var overlayMaps = {
            "T√≤a nh√†": buildingsLayer,
            "Ph√≤ng": roomsLayer,
            "C√¢y xanh": treesLayer,
            "Thi·∫øt b·ªã": equipmentLayer,
            "S·ª± c·ªë": incidentsLayer
        };
        L.control.layers(null, overlayMaps).addTo(map);

        // Helper: ·∫©n t·∫•t c·∫£ l·ªõp tr·ª´ t√≤a nh√†, ch·ªâ gi·ªØ l·∫°i layer k·∫øt qu·∫£ c·∫ßn hi·ªÉn th·ªã
        function hideAllExceptBuildings() {
            if (!map.hasLayer(buildingsLayer)) {
                map.addLayer(buildingsLayer);
            }
            [treesLayer, roomsLayer, equipmentLayer, incidentsLayer].forEach(function (layer) {
                if (map.hasLayer(layer)) {
                    map.removeLayer(layer);
                }
            });
        }

        // Helper: hi·ªÉn th·ªã l·∫°i t·∫•t c·∫£ l·ªõp g·ªëc, x√≥a l·ªõp k·∫øt qu·∫£
        function showAllBaseLayers() {
            [buildingsLayer, treesLayer, roomsLayer, equipmentLayer, incidentsLayer].forEach(function (layer) {
                if (!map.hasLayer(layer)) {
                    map.addLayer(layer);
                }
            });
            radiusResultLayer.clearLayers();
            advancedResultLayer.clearLayers();
        }

        // --- G. Tool: Truy v·∫•n b√°n k√≠nh ---
        var radiusMode = false;

        document.getElementById("btn-radius-search").addEventListener("click", function () {
            radiusMode = true;
            map.getContainer().style.cursor = "crosshair";
            alert("Ch·∫ø ƒë·ªô truy v·∫•n b√°n k√≠nh: h√£y click l√™n b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn t√¢m t√¨m ki·∫øm.");
        });

        // N√∫t quay l·∫°i b·∫£n ƒë·ªì g·ªëc
        document.getElementById("btn-show-all").addEventListener("click", function () {
            showAllBaseLayers();
        });

        map.on("click", function (e) {
            if (!radiusMode) return;
            radiusMode = false;
            map.getContainer().style.cursor = "";

            var radius = prompt("Nh·∫≠p b√°n k√≠nh c·∫ßn t√¨m (m):", "20");
            if (!radius) return;

            // Ch·ªçn l·ªõp mu·ªën hi·ªÉn th·ªã trong b√°n k√≠nh:
            // trees = c√¢y xanh, rooms = ph√≤ng, devices = thi·∫øt b·ªã
            var layersInput = prompt(
                "Nh·∫≠p c√°c l·ªõp mu·ªën hi·ªÉn th·ªã trong b√°n k√≠nh (c√°ch nhau b·∫±ng d·∫•u ph·∫©y):\n" +
                    "- trees = C√¢y xanh\n" +
                    "- rooms = Ph√≤ng h·ªçc / ph√≤ng\n" +
                    "- devices = Thi·∫øt b·ªã\n\n" +
                    "V√≠ d·ª•: trees,rooms ho·∫∑c trees,devices,rooms",
                "trees,devices,rooms"
            );
            if (layersInput === null) return;
            var layers = layersInput.trim();
            if (!layers) {
                layers = "trees,devices,rooms";
            }

            // N·∫øu c√≥ ch·ªçn c√¢y xanh / thi·∫øt b·ªã th√¨ cho ph√©p l·ªçc theo tr·∫°ng th√°i
            var layerSet = new Set(
                layers
                    .split(",")
                    .map(function (s) {
                        return s.trim();
                    })
                    .filter(Boolean)
            );

            var allowedTreeStatuses = new Set(["good", "diseased", "dangerous"]);
            var allowedDeviceStatuses = new Set(["good", "broken", "maintenance"]);

            if (layerSet.has("trees")) {
                var treeStatusInput = prompt(
                    "Ch·ªçn tr·∫°ng th√°i c√¢y mu·ªën hi·ªÉn th·ªã (c√°ch nhau b·∫±ng d·∫•u ph·∫©y):\n" +
                        "- good = Kh·ªèe\n" +
                        "- diseased = B·ªánh\n" +
                        "- dangerous = Nguy hi·ªÉm\n\n" +
                        "V√≠ d·ª•: diseased,dangerous (ch·ªâ hi·ªán c√¢y b·ªánh + nguy hi·ªÉm)\n" +
                        "ƒê·ªÉ m·∫∑c ƒë·ªãnh: good,diseased,dangerous",
                    "good,diseased,dangerous"
                );
                if (treeStatusInput !== null && treeStatusInput.trim()) {
                    allowedTreeStatuses = new Set(
                        treeStatusInput
                            .split(",")
                            .map(function (s) {
                                return s.trim();
                            })
                            .filter(Boolean)
                    );
                }
            }

            if (layerSet.has("devices")) {
                var deviceStatusInput = prompt(
                    "Ch·ªçn tr·∫°ng th√°i thi·∫øt b·ªã mu·ªën hi·ªÉn th·ªã (c√°ch nhau b·∫±ng d·∫•u ph·∫©y):\n" +
                        "- good = T·ªët\n" +
                        "- broken = H·ªèng\n" +
                        "- maintenance = ƒêang s·ª≠a\n\n" +
                        "V√≠ d·ª•: broken,maintenance (ch·ªâ hi·ªán thi·∫øt b·ªã h·ªèng / ƒëang s·ª≠a)\n" +
                        "ƒê·ªÉ m·∫∑c ƒë·ªãnh: good,broken,maintenance",
                    "good,broken,maintenance"
                );
                if (deviceStatusInput !== null && deviceStatusInput.trim()) {
                    allowedDeviceStatuses = new Set(
                        deviceStatusInput
                            .split(",")
                            .map(function (s) {
                                return s.trim();
                            })
                            .filter(Boolean)
                    );
                }
            }

            fetch(
                radiusSearchUrl +
                    "?lat=" +
                    encodeURIComponent(e.latlng.lat) +
                    "&lng=" +
                    encodeURIComponent(e.latlng.lng) +
                    "&radius=" +
                    encodeURIComponent(radius) +
                    "&layers=" +
                    encodeURIComponent(layers)
            )
                .then((res) => res.json())
                .then(function (data) {
                    radiusResultLayer.clearLayers();

                    // ·∫®n t·∫•t c·∫£ l·ªõp tr·ª´ t√≤a nh√†, ch·ªâ hi·ªÉn th·ªã k·∫øt qu·∫£ truy v·∫•n
                    hideAllExceptBuildings();
                    if (!map.hasLayer(radiusResultLayer)) {
                        map.addLayer(radiusResultLayer);
                    }

                    // V·∫Ω v√≤ng tr√≤n b√°n k√≠nh
                    L.circle(e.latlng, {
                        radius: parseFloat(radius),
                        color: "#2e7d32",
                        weight: 2,
                        fillColor: "#a5d6a7",
                        fillOpacity: 0.15,
                    }).addTo(radiusResultLayer);

                    if (data.trees) {
                        // L·ªçc theo tr·∫°ng th√°i c√¢y ƒë∆∞·ª£c ch·ªçn
                        var filteredTrees = {
                            type: "FeatureCollection",
                            features: (data.trees.features || []).filter(function (f) {
                                var st = f.properties && f.properties.health_status;
                                return allowedTreeStatuses.has(st);
                            }),
                        };

                        L.geoJSON(filteredTrees, {
                            pointToLayer: treePoint,
                            onEachFeature: function (feature, layer) {
                                var status = feature.properties.health_status;
                                var icon = "üå≥";
                                if (status == "dangerous") icon = "‚ö†Ô∏è";
                                var viStatus = VI_TREE_STATUS[status] || status;
                                layer.bindPopup(
                                    "<b>" +
                                        icon +
                                        " C√¢y: " +
                                        feature.properties.species +
                                        "</b>" +
                                        "<br>M√£: " +
                                        feature.properties.code +
                                        "<br>T√¨nh tr·∫°ng: " +
                                        viStatus
                                );
                            },
                        }).addTo(radiusResultLayer);
                    }

                    if (data.equipment) {
                        // L·ªçc theo tr·∫°ng th√°i thi·∫øt b·ªã ƒë∆∞·ª£c ch·ªçn
                        var filteredEquip = {
                            type: "FeatureCollection",
                            features: (data.equipment.features || []).filter(function (f) {
                                var st = f.properties && f.properties.status;
                                return allowedDeviceStatuses.has(st);
                            }),
                        };

                        L.geoJSON(filteredEquip, {
                            pointToLayer: equipmentPoint,
                            onEachFeature: function (feature, layer) {
                                layer.bindPopup(
                                    "<b>‚öôÔ∏è Thi·∫øt b·ªã: " +
                                        (feature.properties.code || "") +
                                        "</b>" +
                                        "<br>T√™n: " +
                                        (feature.properties.name || "") +
                                        "<br>Tr·∫°ng th√°i: " +
                                        (feature.properties.status || "")
                                );
                            },
                        }).addTo(radiusResultLayer);
                    }

                    if (data.rooms) {
                        L.geoJSON(data.rooms, {
                            pointToLayer: roomPoint,
                            onEachFeature: function (feature, layer) {
                                layer.bindPopup(
                                    "<b>üö™ Ph√≤ng: " +
                                        (feature.properties.name || "") +
                                        "</b>" +
                                        "<br>Lo·∫°i: " +
                                        (feature.properties.room_type || "")
                                );
                            },
                        }).addTo(radiusResultLayer);
                    }
                })
                .catch(function (err) {
                    console.error(err);
                    alert("Kh√¥ng truy v·∫•n ƒë∆∞·ª£c d·ªØ li·ªáu b√°n k√≠nh.");
                });
        });

        // --- H. Tool: Truy v·∫•n n√¢ng cao (c√¢y nguy hi·ªÉm / thi·∫øt b·ªã c·∫ßn ki·ªÉm tra) ---
        var queryResultsEl = document.getElementById("query-results");

        function renderResults(title, itemsHtml) {
            queryResultsEl.innerHTML =
                "<strong>" +
                title +
                "</strong>" +
                (itemsHtml || "<div>Kh√¥ng c√≥ k·∫øt qu·∫£.</div>");
        }

        document
            .getElementById("btn-dangerous-trees")
            .addEventListener("click", function () {
                fetch(dangerousTreesUrl)
                    .then((res) => res.json())
                    .then(function (data) {
                        advancedResultLayer.clearLayers();

                        // ·∫®n t·∫•t c·∫£ l·ªõp tr·ª´ t√≤a nh√†, ch·ªâ hi·ªÉn th·ªã c√¢y nguy hi·ªÉm
                        hideAllExceptBuildings();
                        if (!map.hasLayer(advancedResultLayer)) {
                            map.addLayer(advancedResultLayer);
                        }

                        var items = [];
                        if (data.features && data.features.length) {
                            var layer = L.geoJSON(data, {
                                pointToLayer: treePoint,
                                onEachFeature: function (feature, layer) {
                                    var p = feature.properties || {};
                                    var text = (p.code || "") + " - " + (p.species || "");
                                    items.push(
                                        '<div class="result-item">' +
                                            text +
                                            "</div>"
                                    );
                                    layer.bindPopup("<b>C√¢y nguy hi·ªÉm</b><br>" + text);
                                },
                            }).addTo(advancedResultLayer);

                            try {
                                map.fitBounds(layer.getBounds(), { padding: [30, 30] });
                            } catch (e) {}
                        }

                        renderResults("C√¢y nguy hi·ªÉm", items.join(""));
                    })
                    .catch(function (err) {
                        console.error(err);
                        alert("Kh√¥ng truy v·∫•n ƒë∆∞·ª£c c√¢y nguy hi·ªÉm.");
                    });
            });

        document
            .getElementById("btn-devices-check")
            .addEventListener("click", function () {
                fetch(devicesToCheckUrl)
                    .then((res) => res.json())
                    .then(function (data) {
                        advancedResultLayer.clearLayers();

                        // ·∫®n t·∫•t c·∫£ l·ªõp tr·ª´ t√≤a nh√†, ch·ªâ hi·ªÉn th·ªã thi·∫øt b·ªã c·∫ßn ki·ªÉm tra
                        hideAllExceptBuildings();
                        if (!map.hasLayer(advancedResultLayer)) {
                            map.addLayer(advancedResultLayer);
                        }

                        var items = [];
                        if (data.features && data.features.length) {
                            var layer = L.geoJSON(data, {
                                pointToLayer: equipmentPoint,
                                onEachFeature: function (feature, layer) {
                                    var p = feature.properties || {};
                                    var text =
                                        (p.code || "") +
                                        " - " +
                                        (p.name || "") +
                                        " (" +
                                        (p.status || "") +
                                        ", ph√≤ng " +
                                        (p.room_name || "?") +
                                        ")";
                                    items.push(
                                        '<div class="result-item">' +
                                            text +
                                            "</div>"
                                    );
                                    layer.bindPopup(
                                        "<b>Thi·∫øt b·ªã c·∫ßn ki·ªÉm tra</b><br>" + text
                                    );
                                },
                            }).addTo(advancedResultLayer);

                            try {
                                map.fitBounds(layer.getBounds(), { padding: [30, 30] });
                            } catch (e) {}
                        }

                        renderResults("Thi·∫øt b·ªã c·∫ßn ki·ªÉm tra/b·∫£o tr√¨", items.join(""));
                    })
                    .catch(function (err) {
                        console.error(err);
                        alert("Kh√¥ng truy v·∫•n ƒë∆∞·ª£c thi·∫øt b·ªã c·∫ßn ki·ªÉm tra.");
                    });
            });

        // --- I. T√¨m ki·∫øm s·ª± c·ªë tr√™n b·∫£n ƒë·ªì (client-side t·ª´ incidentsData) ---
        document
            .getElementById("btn-search-incidents")
            .addEventListener("click", function () {
                var q = document
                    .getElementById("incident-search-input")
                    .value.trim()
                    .toLowerCase();

                // Lu√¥n clear k·∫øt qu·∫£ c≈© tr∆∞·ªõc khi t√¨m m·ªõi
                advancedResultLayer.clearLayers();
                radiusResultLayer.clearLayers();

                // N·∫øu kh√¥ng nh·∫≠p g√¨: hi·ªÉn th·ªã t·∫•t c·∫£ s·ª± c·ªë
                var allFeatures = incidentsData.features || [];
                var filtered = allFeatures.filter(function (f) {
                    if (!q) return true;
                    var p = f.properties || {};
                    var title = (p.title || "").toLowerCase();
                    var status = (p.status || "").toLowerCase();
                    var priority = (p.priority || "").toLowerCase();
                    var viPriority = (p.vi_priority || "").toLowerCase();
                    var viStatus = (p.vi_status || "").toLowerCase();
                    var incidentType = (p.incident_type || "").toLowerCase();
                    var incidentTypeCode = (p.incident_type_code || "").toLowerCase();
                    var assetType = (p.asset_type || "").toLowerCase();
                    var assetSearchText = (p.asset_search_text || "").toLowerCase();
                    // G√µ: cao/trung b√¨nh/th·∫•p, m·ªü/ƒëang x·ª≠ l√Ω/ƒë√£ ƒë√≥ng, t√™n t√†i s·∫£n (me t√¢y, loa, pc ƒë√†i loan...)
                    return (
                        title.indexOf(q) !== -1 ||
                        status.indexOf(q) !== -1 ||
                        priority.indexOf(q) !== -1 ||
                        viPriority.indexOf(q) !== -1 ||
                        viStatus.indexOf(q) !== -1 ||
                        incidentType.indexOf(q) !== -1 ||
                        incidentTypeCode.indexOf(q) !== -1 ||
                        assetType.indexOf(q) !== -1 ||
                        assetSearchText.indexOf(q) !== -1
                    );
                });

                if (!filtered.length) {
                    renderResults("K·∫øt qu·∫£ t√¨m ki·∫øm s·ª± c·ªë", "<div>Kh√¥ng t√¨m th·∫•y s·ª± c·ªë ph√π h·ª£p.</div>");
                    return;
                }

                // Ch·ªâ hi·ªÉn th·ªã s·ª± c·ªë t√¨m ƒë∆∞·ª£c + t√≤a nh√†, ·∫©n m·ªçi th·ª© kh√°c
                radiusResultLayer.clearLayers();
                hideAllExceptBuildings();
                if (!map.hasLayer(advancedResultLayer)) {
                    map.addLayer(advancedResultLayer);
                }

                var collection = {
                    type: "FeatureCollection",
                    features: filtered,
                };

                var items = [];
                var layer = L.geoJSON(collection, {
                    pointToLayer: incidentPoint,
                    onEachFeature: function (feature, layer) {
                        var p = feature.properties || {};
                        var text =
                            (p.title || "") +
                            " (" +
                            (VI_INCIDENT_STATUS[p.status] || p.status || "") +
                            ", " +
                            (VI_INCIDENT_PRIORITY[p.priority] || p.priority || "") +
                            ")";
                        items.push(
                            '<div class="result-item">' +
                                text +
                                "</div>"
                        );
                        layer.bindPopup("<b>S·ª± c·ªë</b><br>" + text);
                    },
                }).addTo(advancedResultLayer);

                try {
                    map.fitBounds(layer.getBounds(), { padding: [30, 30] });
                } catch (e) {}

                renderResults("K·∫øt qu·∫£ t√¨m ki·∫øm s·ª± c·ªë", items.join(""));
            });

        // --- J. Ch√∫ th√≠ch b·∫£n ƒë·ªì ƒë√≥ng/m·ªü ---
        (function () {
            var legend = document.getElementById("map-legend");
            var toggle = document.getElementById("legend-toggle");
            var body = document.getElementById("legend-body");
            if (legend && toggle && body) {
                toggle.addEventListener("click", function () {
                    legend.classList.toggle("collapsed");
                    toggle.setAttribute(
                        "aria-expanded",
                        legend.classList.contains("collapsed") ? "false" : "true"
                    );
                });
            }
        })();

    </script>
</body>
</html>